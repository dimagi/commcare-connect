{% extends "base.html" %}

{% load render_table from django_tables2 %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block content %}
    <h1>Delivery Stats Report</h1>

    <form hx-get="{{ report_url }}"
          hx-target="div.table-container"
          hx-swap="outerHTML"
          hx-trigger="change"
          hx-push-url="true"
          hx-params="not csrfmiddlewaretoken"
          hx-indicator="#table-loading-indicator"
          class="form-inline">
        {% crispy filter.form %}
    </form>

    <div class="table-report-wrapper">
        <div id="table-loading-indicator"
             class="table-loading-indicator"
             aria-live="polite"
             aria-hidden="true">
            <span class="table-loading-spinner" aria-hidden="true"></span>
            <span class="table-loading-text">{% trans "Loadingâ€¦" %}</span>
        </div>
        {% render_table table %}
    </div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<!-- This is required for select2 'user' field-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
 window.addEventListener("DOMContentLoaded", (e) => {
  $('select').on('select2:select', function (e) {
   $(this).closest('form').get(0).dispatchEvent(new Event('change'));
  });
  monthPickr("#id_from_date", {
    altInput: true,
  }, {
    dateFormat: "Y-m",
    altFormat: "F Y",
  });
  monthPickr("#id_to_date", {
    altInput: true,
  }, {
    dateFormat: "Y-m",
    altFormat: "F Y",
  });
 })
</script>

{% endblock %}

{% block css %}
{{ block.super }}
<style>
.select2-selection__rendered {
    line-height: initial!important;
}

.table-report-wrapper {
    position: relative;
}

.table-loading-indicator {
    display: none;
    position: absolute;
    inset: 0;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    background: rgba(255, 255, 255, 0.85);
    z-index: 10;
    min-height: 12rem;
}

.table-loading-indicator.htmx-request {
    display: flex;
}

.table-loading-spinner {
    width: 2rem;
    height: 2rem;
    border: 3px solid #e2e8f0;
    border-top-color: #64748b;
    border-radius: 50%;
    animation: table-loading-spin 0.7s linear infinite;
}

@keyframes table-loading-spin {
    to { transform: rotate(360deg); }
}

.table-loading-text {
    font-size: 0.875rem;
    color: #64748b;
}
</style>
{% endblock %}
