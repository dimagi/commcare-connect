{% extends "solicitations/public_base.html" %}
{% load static %}
{% load crispy_forms_tags %}


{% block page_title %}Submit Response - {{ solicitation.title }}{% endblock %}

{% block hero_title %}Submit Your Response{% endblock %}

{% block hero_description %}
    {{ solicitation.title }}
{% endblock %}

{% block main_content %}
    <!-- Breadcrumb Navigation -->
    <ul class="breadcrumb mb-8">
        <li>
            <a href="{% url 'solicitations:list' %}">All Opportunities</a>
            <i class="fa-solid fa-chevron-right"></i>
        </li>
        <li>
            <a href="{% url 'solicitations:'|add:solicitation.solicitation_type|add:'_list' %}">{{ solicitation.get_solicitation_type_display }}s</a>
            <i class="fa-solid fa-chevron-right"></i>
        </li>
        <li>
            <a href="{% url 'solicitations:detail' pk=solicitation.pk %}">{{ solicitation.title|truncatechars:30 }}</a>
            <i class="fa-solid fa-chevron-right"></i>
        </li>
        <li>
            <a href="#">Submit Response</a>
            <i class="fa-solid fa-chevron-right"></i>
        </li>
    </ul>

    <!-- Response Form -->
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-sm p-8 mb-8">
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-semibold text-brand-deep-purple mb-2">
                            {% if is_editing_draft %}
                                <i class="fa-solid fa-pencil mr-2 text-yellow-600"></i>
                                Editing Draft Response
                            {% else %}
                                Response Form
                            {% endif %}
                        </h2>
                        <p class="text-gray-600">
                            {% if is_editing_draft %}
                                Continue working on your saved response. You can save your progress or submit when ready.
                            {% else %}
                                Please complete all required fields below to submit your organization's response.
                            {% endif %}
                        </p>
                    </div>
                    {% if is_editing_draft %}
                        <div class="text-right">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <i class="fa-solid fa-clock mr-2"></i>
                                Last saved: <time class="local-datetime" datetime="{{ draft.date_modified|date:'c' }}">{{ draft.date_modified|date:"M j, Y g:i A" }}</time>
                            </span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Solicitation Summary -->
            <div class="flex flex-col p-6 rounded-xl shadow-sm bg-white gap-5 relative mb-8">
                <div class="absolute w-8 bg-brand-mango h-2 top-0 -translate-y-1/2 left-6 rounded-full"></div>

                <div class="flex w-full justify-between">
                    <div class="w-full">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="badge badge-md {% if solicitation.solicitation_type == 'eoi' %}primary-light{% else %}warning-light{% endif %}">
                                {{ solicitation.get_solicitation_type_display }}
                            </span>
                            <div class="flex items-center gap-1 text-sm text-green-600">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span>Active</span>
                            </div>
                        </div>
                        <p class="card_title">{{ solicitation.title }}</p>
                        <p class="card_description w-full max-w-3xl">{{ solicitation.description|truncatewords:30 }}</p>
                    </div>
                </div>

                <!-- Key Information Row -->
                <div class="bg-neutral-100 rounded-lg w-full px-5 py-4">
                    <div class="flex gap-2 w-full items-center justify-between flex-wrap">
                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-building"></i>
                                <div>
                                    <h6>Program</h6>
                                    <p>{{ solicitation.program.name }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-location-dot"></i>
                                <div>
                                    <h6>Target Population</h6>
                                    <p>{{ solicitation.target_population }}</p>
                                </div>
                            </div>
                        </div>

                        {% if solicitation.estimated_scale %}
                            <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                            <div class="flex gap-2 items-start">
                                <div class="infocard-dark">
                                    <i class="fa-solid fa-chart-bar"></i>
                                    <div>
                                        <h6>Scale</h6>
                                        <p>{{ solicitation.estimated_scale }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-clock"></i>
                                <div>
                                    <h6>Application Deadline</h6>
                                    <p>{{ solicitation.application_deadline|date:"M j, Y" }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-calendar-check"></i>
                                <div>
                                    <h6>Start Date</h6>
                                    <p>{{ solicitation.expected_start_date|date:"M Y"|default:"TBD" }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-calendar-xmark"></i>
                                <div>
                                    <h6>End Date</h6>
                                    <p>{{ solicitation.expected_end_date|date:"M Y"|default:"TBD" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Form -->
            <form id="response-form" method="post" enctype="multipart/form-data" class="space-y-6" novalidate>
                {% csrf_token %}

                <!-- Organization Info -->
                <div class="bg-white rounded-lg p-6">
                    <h4 class="text-lg font-medium text-brand-deep-purple mb-3">
                        <i class="fa-solid fa-building mr-2"></i>
                        Organization Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Organization:</span>
                            <span class="ml-2">{{ user.memberships.first.organization.name }}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Submitted by:</span>
                            <span class="ml-2">{{ user.get_full_name }} ({{ user.email }})</span>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Questions -->
                {% if questions %}
                    <div class="bg-white rounded-lg p-6 space-y-6">
                        <h4 class="text-lg font-medium text-brand-deep-purple">
                            <i class="fa-solid fa-clipboard-question mr-2"></i>
                            Application Questions
                        </h4>

                        {% for field in form %}
                            {% if field.name != 'attachments' %}
                                <div class="border border-gray-200 rounded-lg p-6">
                                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        {{ field.label }}
                                        {% if field.field.required %}
                                            <span class="text-red-500">*</span>
                                        {% endif %}
                                    </label>

                                    {{ field }}

                                    {% if field.errors %}
                                        {% for error in field.errors %}
                                            <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Form Actions -->
                <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                    <div class="flex items-center gap-4">
                        <a href="{% url 'solicitations:detail' pk=solicitation.pk %}"
                           class="button button-md outline-style">
                            <i class="fa-solid fa-arrow-left mr-2"></i>
                            Back to Solicitation
                        </a>

                        {% if user.memberships.exists %}
                            <a href="{% url 'solicitations:draft_list' %}"
                               class="button button-md outline-style">
                                <i class="fa-solid fa-file-lines mr-2"></i>
                                My Drafts
                            </a>
                        {% endif %}
                    </div>

                    <div class="flex items-center gap-4">
                        <button type="submit" name="action" value="save_draft"
                                class="button button-md outline-style"
                                id="save-draft-btn">
                            <i class="fa-solid fa-floppy-disk mr-2"></i>
                            Save Draft
                        </button>

                        <button type="submit" name="action" value="submit"
                                class="button button-md primary-dark"
                                id="submit-btn">
                            <i class="fa-solid fa-paper-plane mr-2"></i>
                            Submit Response
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- File Attachments Section (Outside Main Form) -->
        <div class="bg-white rounded-xl shadow-sm p-8">
            <h4 class="text-lg font-medium text-brand-deep-purple mb-3">
                <i class="fa-solid fa-paperclip mr-2"></i>
                Supporting Documents
            </h4>
            <p class="text-sm text-gray-600 mb-4">
                Upload supporting documents for your response (optional). You can upload multiple files one at a time.
            </p>

            <!-- File Upload Form (Separate from main form) -->
            <form method="post" enctype="multipart/form-data" action="{% url 'solicitations:upload_attachment' pk=solicitation.pk %}" class="mb-6">
                {% csrf_token %}
                <div class="flex items-end gap-3">
                    <div class="flex-1">
                        <input type="file"
                               name="attachment"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-indigo focus:border-brand-indigo"
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"
                               required>
                    </div>
                    <button type="submit" class="button button-md primary-dark">
                        <i class="fa-solid fa-upload mr-2"></i>
                        Upload File
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    Accepted formats: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (Max 10MB per file)
                </p>
            </form>

            <!-- Uploaded Files List -->
            {% if existing_attachments %}
                <div class="space-y-2">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">Uploaded Files:</h5>
                    {% for attachment in existing_attachments %}
                        <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <i class="fa-solid fa-file-alt text-green-600 mr-3"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ attachment.original_filename }}</p>
                                    <p class="text-xs text-gray-500">{{ attachment.file_size_mb }} MB • Uploaded <time class="local-datetime" datetime="{{ attachment.date_created|date:'c' }}">{{ attachment.date_created|date:"M j, Y g:i A" }}</time></p>
                                </div>
                            </div>
                            <form method="post" action="{% url 'solicitations:delete_attachment' pk=solicitation.pk attachment_id=attachment.pk %}" class="inline">
                                {% csrf_token %}
                                <button type="submit"
                                        class="text-red-600 hover:text-red-800 p-1"
                                        title="Delete file"
                                        onclick="return confirm('Are you sure you want to delete this file?')">
                                    <i class="fa-solid fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-4 text-gray-500 text-sm">
                    No files uploaded yet.
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block inline_javascript %}
<script>
// Simple timezone conversion function
function convertTimestamps() {
    console.log('Converting timestamps...');
    var elements = document.querySelectorAll('.local-datetime');
    console.log('Found elements:', elements.length);

    for (var i = 0; i < elements.length; i++) {
        var element = elements[i];
        var isoDateTime = element.getAttribute('datetime');
        console.log('Processing datetime:', isoDateTime);

        if (isoDateTime) {
            var date = new Date(isoDateTime);
            var localTime = date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            console.log('Converted to:', localTime);
            element.textContent = localTime;
        }
    }
}

// Run conversion when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', convertTimestamps);
} else {
    convertTimestamps();
}

document.addEventListener('DOMContentLoaded', function() {

    const form = document.getElementById('response-form');
    const saveDraftBtn = document.getElementById('save-draft-btn');
    const submitBtn = document.getElementById('submit-btn');

    // Auto-save functionality (text only, files handled separately)
    let autoSaveTimer;
    const autoSaveDelay = 30000; // 30 seconds

    function collectFormData() {
        const formData = new FormData(form);
        const responses = {};

        // Collect all form fields (excluding files and form actions)
        for (let [key, value] of formData.entries()) {
            if (key !== 'csrfmiddlewaretoken' && key !== 'action') {
                responses[key] = value;
            }
        }

        return { responses: responses };
    }

    function saveAsDraft() {
        const data = collectFormData();

        fetch("{% url 'solicitations:save_draft' pk=solicitation.pk %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Draft saved automatically', 'success');
            } else {
                console.error('Auto-save failed:', data.error);
            }
        })
        .catch(error => {
            console.error('Auto-save error:', error);
        });
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        let bgColor = 'bg-blue-500';
        let icon = 'info';

        if (type === 'success') {
            bgColor = 'bg-green-500';
            icon = 'check';
        } else if (type === 'error') {
            bgColor = 'bg-red-500';
            icon = 'exclamation-triangle';
        }

        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow-lg z-50 ${bgColor} text-white`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fa-solid fa-${icon}-circle mr-2"></i>
                ${message}
            </div>
        `;

        document.body.appendChild(notification);

        // Remove after 3 seconds (longer for errors)
        setTimeout(() => {
            notification.remove();
        }, type === 'error' ? 5000 : 3000);
    }

    // Set up auto-save on form changes (only for main response form)
    if (form) {
        form.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveAsDraft, autoSaveDelay);
        });

        form.addEventListener('change', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveAsDraft, autoSaveDelay);
        });
    }

    // Manual save draft button
    if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', function(e) {
            showNotification('Saving draft...', 'info');
        });
    }

    // Submit button validation and confirmation
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            // Check required fields only for submission
            const requiredFields = form.querySelectorAll('[required]');
            let hasEmptyRequired = false;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    hasEmptyRequired = true;
                    field.style.borderColor = '#ef4444';
                    field.style.boxShadow = '0 0 0 1px #ef4444';
                } else {
                    field.style.borderColor = '';
                    field.style.boxShadow = '';
                }
            });

            if (hasEmptyRequired) {
                e.preventDefault();
                showNotification('Please fill in all required fields before submitting.', 'error');
                return;
            }

            if (!confirm('Are you sure you want to submit this response? Once submitted, you cannot make changes.')) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
