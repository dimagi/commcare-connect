<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("mapController", () => ({
            panelOpen: true,
            map: null,
            selectedWards: [],

            init() {
                this.$nextTick(() => {
                    this.initializeMap();
                });
            },

            initializeMap() {
                const accessToken = '{{ mapbox_api_key|escapejs }}';
                if (!MapboxUtils.setAccessToken(accessToken)) return;

                this.map = MapboxUtils.createMap({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/standard',
                    projection: 'globe',
                    zoom: 6,
                    center: [8.675, 9.082]
                });

                MapboxUtils.addNavigation(this.map, 'top-left');

                const draw = MapboxUtils.addDrawControls(this.map);

                this.map.on('style.load', () => {
                    this.map.setFog({});
                });

                const $mapContainer = document.getElementById('map');
                const observer = new ResizeObserver(() => {
                    this.map.resize();
                });
                observer.observe($mapContainer);
            },

            togglePanel() {
                this.panelOpen = !this.panelOpen;
            },

            fetchSelectedWards() {
                if (!this.selectedWards || this.selectedWards.length === 0) return;

                const url = `{% url 'microplanning:get_wards_features' org_slug=request.org.slug %}?wards=${this.selectedWards}`;
                fetch(url).then(response => response.json()).then(data => {
                    if (!data) return;
                    for (const wardFeatures of data) {
                        const sourceId = `ward-${wardFeatures.id}-source`;
                        MapboxUtils.drawFeature(this.map, sourceId, wardFeatures.features);
                    }
                });
            }
        }));
    });
</script>
