{% load i18n static %}

<div id="import-parent" x-show="showImportWorkAreaModal" class="modal-backdrop" x-cloak x-init="showImportWorkAreaModal = true">
    <div class="modal">

        <!-- Header -->
        <div class="header text-lg font-semibold text-brand-deep-purple flex justify-between items-center">
            <h1>{% translate "Upload Work Areas" %}</h1>
        </div>

        <!-- Modal Body -->
        <div id="import-result" {% if task_id and not result_ready %}
            hx-get="{% url 'microplanning:import_status' request.org.slug request.opportunity.opportunity_id %}?task_id={{ task_id }}"
            hx-trigger="every 2s" hx-target="#import-parent" hx-swap="outerHTML" {% endif %}>

            {% if task_id and not result_ready %}
            <!-- Spinner -->
            <div class="flex flex-col items-center justify-center mt-4">
                <i class="fa-solid fa-spinner animate-spin text-amber-500 text-5xl"></i>
                <p class="text-sm text-gray-600 font-medium animate-pulse mt-4">
                    {% translate "Uploading your file… This may take a moment." %}
                </p>
            </div>

            {% elif task_id and result_ready %}
            <!-- Results -->
            {% if result_data.errors %}
            <div class="mt-4 border-t border-gray-100 pt-4">
                <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2 mb-3">
                    <i class="fa-solid fa-circle-exclamation text-red-500"></i>
                    {% translate "Issues Found in CSV" %}
                </h3>

                <div class="max-h-64 overflow-y-auto custom-scrollbar border border-gray-200 rounded-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                    {% translate "Error Description" %}
                                </th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-24">
                                    {% translate "Row Numbers" %}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            {% for msg, lines in result_data.errors.items %}
                            <tr class="hover:bg-red-50/30 transition-colors">
                                <td class="px-3 py-2 text-sm text-gray-700 leading-snug">{{ msg }}</td>
                                <td class="px-3 py-2 text-right text-sm text-red-600 font-mono font-medium">
                                    {{ lines|join:", " }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <p class="mt-3 text-xs text-gray-500 text-center">
                    {% translate "Please fix the rows listed above and re-upload." %}
                </p>
            </div>

            {% elif result_data.created %}
            <div class="mt-4 border-t border-gray-100 pt-4 text-green-600 text-center">
                <i class="fa-solid fa-circle-check"></i> {% translate "Successfully created" %} {{ result_data.created }} {% translate "work area(s)" %}
            </div>
            {% endif %}
            <div class="footer flex justify-end gap-2 p-4">
                <a href="{% url 'microplanning:microplanning_home' request.org.slug request.opportunity.opportunity_id %}"
                    class="button button-md outline-style text-center">
                    {% translate "Close" %}
                </a>
            </div>
            {% else %}
            <!-- Upload Form -->
            <form method="POST" enctype="multipart/form-data"
                action="{% url 'microplanning:upload_work_areas' request.org.slug request.opportunity.opportunity_id %}"
                class="content">
                {% csrf_token %}

                <div class="modal-body flex flex-col items-center text-center p-6">

                    <div class="mb-2 text-indigo-600">
                        <i class="fa-solid fa-cloud-arrow-up text-5xl"></i>
                    </div>

                    <a href="{% url 'microplanning:upload_work_areas' request.org.slug request.opportunity.opportunity_id %}"
                        class="mt-6 flex items-center px-4 py-1.5 border border-gray-800 rounded-md text-sm font-medium hover:bg-gray-50 transition mb-4">
                        <i class="fa-solid fa-file-arrow-down mr-2"></i>
                        {% translate "Download Template" %}
                    </a>

                    <div class="w-full text-left mt-4" x-data="{ fileName: '' }">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            {% translate "Select CSV File" %}
                        </label>

                        <div class="relative border-2 rounded-lg px-4 py-4 bg-gray-50 hover:border-brand-deep-purple">
                            <input type="file" name="csv_file" accept=".csv" required
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                @change="fileName = $event.target.files[0]?.name || ''">
                            <span class="text-gray-500 text-sm"
                                x-text="fileName || '{% translate 'No file chosen' %}'"></span>
                        </div>

                        <div class="mt-3 text-xs text-gray-600 space-y-1">
                            <p class="font-semibold">{% translate "CSV Column Requirements:" %}</p>
                            <ul class="list-disc ml-4">
                                <li>{% translate "Area Slug – unique identifier for each work area should be unique in an opportunity" %}
                                </li>
                                <li>{% translate "Ward – name of the ward" %}</li>
                                <li>{% translate "Centroid – longitude and latitude separated by space (e.g. 77.123 28.456)" %}
                                </li>
                                <li>{% translate "Boundary – Polygon in WKT format" %}</li>
                                <li>{% translate "Building Count – positive integer" %}</li>
                                <li>{% translate "Expected Visit Count – positive integer" %}</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="footer flex justify-end gap-2 p-4">
                    <button type="button" @click="showImportWorkAreaModal = false"
                        class="button button-md outline-style">
                        {% translate "Close" %}
                    </button>
                    <button type="submit" class="button button-md primary-dark">
                        {% translate "Upload" %}
                    </button>
                </div>
            </form>

            {% endif %}
        </div>
    </div>
</div>
