{% extends "account/base.tailwind.html" %}

{% load static %}
{% load i18n %}
{% load socialaccount %}

{% block head_title %}{% translate "Signup" %}{% endblock %}

{% block inner %}
<form method="post" class="w-full min-h-[620px] h-fit flex flex-col gap-4">
  {% csrf_token %}
  <h6 class="title text-brand-deep-purple">Signup</h6>
  <span class="text-sm text-gray-600">Please enter your details</span>

  {% if form.non_field_errors %}
    {% for error in form.non_field_errors %}
      <p class="text-sm text-red-600">* {{ error }}</p>
    {% endfor %}
  {% endif %}

  <div class="input-group {% if form.email.errors %}error{% endif %}">
        <div class="simple-input">
            <input type="email"
                   placeholder="Enter Email ID"
                   required
                   id={{ form.email.auto_id }}
                   {% if form.email.value != None %}value="{{ form.email.value|stringformat:'s' }}"{% endif %}
                   name={{ form.email.html_name }}>
            <i class="fa-light fa-envelope"></i>
            <span class="error-icon fa-solid fa-circle-exclamation"></span>
        </div>
        {% for error in form.email.errors %}
          <p class="error-msg">* {{ error }}</p>
        {% endfor %}
    </div>

  <div class="input-group {% if form.password1.errors %}error{% endif %}">
        <div class="simple-input">
            <input type="password"
                   placeholder="Password"
                   required
                   id={{ form.password1.auto_id }}
                   {% if form.password1.value != None %}value="{{ form.password1.value|stringformat:'s' }}"{% endif %}
                   name={{ form.password1.html_name }}>
            <i class="fa-light fa-lock"></i>
            <span class="error-icon fa-solid fa-circle-exclamation"></span>
        </div>
        {% for error in form.password1.errors %}
          <p class="error-msg">* {{ error }}</p>
        {% endfor %}
    </div>

  <div class="input-group {% if form.password2.errors %}error{% endif %}">
        <div class="simple-input">
            <input type="password"
                   placeholder="Confirm Password"
                   required
                   id={{ form.password2.auto_id }}
                   {% if form.password2.value != None %}value="{{ form.password2.value|stringformat:'s' }}"{% endif %}
                   name={{ form.password2.html_name }}>
            <i class="fa-light fa-lock"></i>
            <span class="error-icon fa-solid fa-circle-exclamation"></span>
        </div>
        {% for error in form.password2.errors %}
          <p class="error-msg">* {{ error }}</p>
        {% endfor %}
    </div>

    <!-- Checkbox and Submit -->
    <div class="flex flex-col items-end gap-3">
        <div class="input-group"
            x-data="{ expanded: false }"
            x-effect="document.body.style.overflow = expanded ? 'hidden' : 'auto'"
             :class="{'error': !termsValid && termsTouched}">
            <div class="flex items-start w-full gap-2">
                <input type="checkbox"
                       class="simple-checkbox aspect-square"
                       required/>
                 <p class="hint">
                  <span>By accessing CommCare Connect, you accept our </span>
                  <button class="font-medium cursor-pointer text-brand-indigo" x-on:click.prevent="expanded = true">Terms & Conditions and Privacy Policy</button>
                  <div x-show="expanded" x-cloak>
                      {% include "tailwind/components/onboarding/terms-condition-modal.html" %}
                  </div>
                </p>
            </div>
            <p class="error-msg">You must accept the terms and conditions</p>
        </div>
        <button class="button button-md primary-dark" type="submit">
            <span class="relative z-20">Signup</span>
        </button>
    </div>

    <span class="text-sm text-center text-gray-600">or</span>
    <!-- Social Login Buttons -->
    <div class="space-y-2 place-items-center">
        <a class="flex items-center gap-2 p-2 pr-4 bg-gray-100 rounded-full cursor-pointer" href="{% provider_login_url "commcarehq" process="login" %}">
            <div class="w-6 h-6">
                <img src="{% static 'images/logo-color.svg' %}" alt="Compact Logo" class="w-full">
            </div>
            <span class="text-sm">Sign up with CommCareHQ</span>
        </a>
    </div>

    <!-- Login Link -->
    <div class="pt-4 mt-auto text-sm text-center text-gray-600 border-t-2 border-t-gray-200">
        Already have an account?
        <a href="{{ login_url }}" class="font-medium text-brand-indigo">Login</a>
    </div>
</form>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('signupForm', () => ({
        email: '',
        password: '',
        confirmPassword: '',
        termsAccepted: false,
        emailTouched: false,
        passwordTouched: false,
        confirmPasswordTouched: false,
        termsTouched: false,
        emailValid: true,
        passwordValid: true,
        confirmPasswordValid: true,
        termsValid: true,

        validateEmail() {
            this.emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.email);
            return this.emailValid;
        },

        validatePassword() {
            this.passwordValid = this.password.length >= 8;
            return this.passwordValid;
        },

        validateConfirmPassword() {
            this.confirmPasswordValid = this.confirmPassword.length >= 8 &&
                                      this.confirmPassword === this.password;
            return this.confirmPasswordValid;
        },

        validateTerms() {
            this.termsValid = this.termsAccepted === true;
            return this.termsValid;
        },

        validateAllFields() {
            this.emailTouched = true;
            this.passwordTouched = true;
            this.confirmPasswordTouched = true;
            this.termsTouched = true;

            const isEmailValid = this.validateEmail();
            const isPasswordValid = this.validatePassword();
            const isConfirmPasswordValid = this.validateConfirmPassword();
            const isTermsValid = this.validateTerms();

            return isEmailValid && isPasswordValid && isConfirmPasswordValid && isTermsValid;
        },

        submitWithValidation() {
            if (this.validateAllFields()) {
                this.$el.dispatchEvent(new CustomEvent('validatedSubmit', { bubbles: true }));
            }
        }
    }));
});
</script>

{% endblock %}
