{% extends 'tailwind/base.html' %}

{% block content %}
<div id="content-area"
  class="md:max-w-screen-2xl mx-auto flex flex-col lg:flex-row gap-4 min-h-screen">
  <div class="w-full lg:w-2/3">
    <h2 class="mb-4 text-brand-deep-purple font-medium text-sm">Programs</h2>
    <div class="flex flex-col gap-4">
      {% for program in programs %}
          <div class="flex flex-col p-6 rounded-xl shadow-sm bg-white gap-5 relative"
               x-data="{
                showOpp: false,
                status: '{{ program.status }}',
                setApplied(e) { if(e?.detail?.successful) this.status = 'applied'}
               }">
          <div class="absolute w-8 bg-brand-mango h-2 top-0 -translate-y-1/2 left-6 rounded-full"></div>
          <div class="flex w-full justify-between">
            <!-- program details -->
            <div class="flex items-center gap-2 font-normal">
              {% if program.status == 'invited' %}
                <div class="h-2 w-2 bg-brand-marigold rounded-full"></div>
              {% elif program.status == 'applied' %}
                <div class="h-2 w-2 bg-brand-deep-purple rounded-full"></div>
              {% elif program.status == 'accepted' %}
                <div class="h-2 w-2 bg-green-600 rounded-full"></div>
              {% endif %}
              <p class="hint">{{ program.organization.name }}</p>
            </div>

            <!-- invitataion status -->
            <div class="flex items-center justify-end gap-6">
              {% if program.status %}
                <span class="badge badge-md"
                      :class="{
                        'warning-dark': status == 'invited',
                        'primary-dark': status == 'applied',
                        'positive-dark': status == 'accepted'
                      }"
                      x-text="status"></span>
              {% endif %}
            </div>
          </div>
          <div>
            <p class="card_title">{{ program.name }}</p>
            <p class="card_description w-1/2">{{ program.description }}</p>
          </div>
          <div class="flex justify-between items-center">
            <!-- program info -->
            <div class="flex items-center gap-6">
                <div class="infocard-dark">
                    <i class="fa-light fa-file-check"></i>
                    <div>
                        <h6>Delivery Type</h6>
                        <p>{{ program.delivery_type.name }}</p>
                    </div>
                </div>
                <div class="line my-2 h-8 w-1 bg-gray-200"></div>
                <div class="infocard-dark">
                    <i class="fa-light fa-calendar-arrow-up"></i>
                    <div>
                        <h6>Start Date</h6>
                        <p>{{ program.start_date }}</p>
                    </div>
                </div>
                <div class="infocard-dark">
                    <i class="fa-light fa-arrow-right text-brand-mango"></i>
                    <div>
                        <h6>End Date</h6>
                        <p>{{ program.end_date }}</p>
                    </div>
                </div>
            </div>

            <!-- button -->
            {% if program.status == 'invited' %}
              <form x-data="{ }"
                    hx-post="{% url "program:apply_or_decline_application" request.org.slug program.id program.id "apply" %}"
                    hx-swap="none"
                    @htmx:after-request="setApplied">
                {% csrf_token %}
                <button class="button button-md" type="submit"
                        :class="{'neutral disabled': status == 'applied', 'primary-dark': status == 'invited'}">
                  <span class="relative z-20">Apply</span>
                </button>
              </form>
            {% elif program.status == 'applied' %}
              <button class="button button-md neutral disabled">
                <span class="relative z-20">Apply</span>
              </button>
            {% elif program.status == 'accepted' %}
              {% if program.managedopportunity_set.all %}
                <button class="button button-md outline-style" @click="showOpp = !showOpp">
                  <span class="relative z-20" x-text="showOpp ? 'Hide Opportunities' : 'View Opportunities'"></span>
                  <i class="fa-light text-xs" :class="showOpp ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </button>
              {% endif %}
            {% endif %}
          </div>
          {% if program.status == 'accepted' %}
            {% if program.managedopportunity_set.all %}
              <div id="opportunity-container" class="flex flex-col gap-y-4 py-4" x-show="showOpp" x-cloak>
                {% for opportunity in program.managedopportunity_set.all %}
                  <div class="relative flex flex-col gap-5 p-6 bg-white rounded-xl border border-gray-200">
                    <div class="flex justify-between w-full">
                      <div class="flex flex-col gap-5 w-1/2">
                        <div class="flex items-center gap-2 font-normal">
                          <div class="w-2 h-2 bg-green-600 rounded-full"></div>
                          <p class="hint">{{ opportunity.organization.name }}</p>
                        </div>
                        <div>
                          <p class="card_title">{{ opportunity.name }}</p>
                          <p class="card_description">{{ opportunity.description }}</p>
                        </div>
                      </div>
                    </div>

                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-6">
                        <div class="infocard-dark">
                            <i class="fa-light fa-calendar-arrow-up"></i>
                            <div>
                                <h6>Start Date</h6>
                                <p>{{opportunity.start_date}}</p>
                            </div>
                        </div>
                        <div class="infocard-dark">
                            <i class="fa-light fa-arrow-right text-brand-mango"></i>
                            <div>
                                <h6>End Date</h6>
                                <p>{{opportunity.end_date}}</p>
                            </div>
                        </div>
                      </div>
                      <a class="button button-md button-outline-rounded" href="{% url "opportunity:detail" request.org.slug opportunity.id %}">
                        <div class="flex items-center justify-between gap-4">
                          <p class="text-sm">View</p>
                          <i class="fa-light fa-arrow-right"></i>
                        </div>
                      </a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
  <!-- Right Column -->

  <div class="w-full lg:w-1/3">
    <div class="mb-4 text-brand-deep-purple font-medium text-sm">Recent Activities</div>
    <div class="bg-gray-100 rounded-lg overflow-y-hidden hover:overflow-y-auto">
      <div class="flex flex-col gap-4">
        {% for data in recent_activities %}
          <div class="activity-comp flex flex-col p-6 rounded-lg bg-white gap-5" x-data="{ expanded: false }">
            <div class="flex gap-4 items-center">
              <i class="fa-light fa-clock-rotate-left"></i>
              <p class="text-base">{{ data.title }}</p>
            </div>
            {% for row in data.rows %}
                <div class="flex justify-between items-center" {% if forloop.counter > 2 %}x-cloak x-show="expanded"{% endif %}>
                  <div>
                    <p class="title">{{ row.opportunity__name }}</p>
                    <p class="hint">{{ row.opportunity__organization__name }}</p>
                  </div>
                  <a class="button button-sm button-outline-rounded" href="{% url "opportunity:detail" request.org.slug row.opportunity__id %}">
                    <div class="flex items-center justify-between gap-4">
                      <p class="text-2xl">{{ row.count }}</p>
                      <i class="fa-light fa-arrow-right"></i>
                    </div>
                  </a>
                </div>
            {% endfor %}
            <div class="flex justify-end" x-show="{{ data.rows|length }} > 2">
              <button class="button-text" @click="expanded = !expanded">
                <span x-text="expanded ? 'less' : 'more'"></span>
                <i :class="expanded ? 'fa-light fa-chevron-up' : 'fa-light fa-chevron-down'"></i>
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
