{% extends 'tailwind/base.html' %}
{% load i18n %}

{% block title %}{{ request.org }} - {{ object.name }}{% endblock %}

{% block content %}
    <div class="container md:max-w-screen-2xl mx-auto flex flex-col gap-4">
      {% include 'tailwind/components/breadcrumbs.html' with path=path %}
        <div class="flex flex-col gap-8 w-full rounded-lg p-4 {% if not object.is_test %}bg-brand-deep-purple{% else %}bg-white shadow-xs{% endif %}">
          <div class="flex items-center {% if object.is_test %}gap-6{% endif %} relative" x-data="{ isOpen: false }">
              <h3 class="text-sm font-medium text-brand-sky flex-1">{% if object.manged %}{{ object.program_name }}{% endif %}</h3>
              {% if object.is_test %}
              <span class="badge badge-md primary-light">Test</span>
              {% endif %}
              <i class="fa-light cursor-pointer {% if not object.is_test %}text-white{% else %}text-gray-800{% endif %}"
                 :class="isOpen ? 'fa-xmark-large' : 'fa-bars'"
                 @click="isOpen = !isOpen"></i>
              <!-- Dropdown Menu -->
              {% include "tailwind/pages/opportunity_dashboard/opportunity_menu.html" with request=request opportunity=object is_program_manager=is_program_manager %}
          </div>
          <div class="flex justify-between items-end">
              <div class="flex flex-col gap-2">
                  <h1 class="text-2xl font-medium {% if not object.is_test %}text-white{% else %}text-brand-deep-purple{% endif %} block">{{ object.name }}</h1>
                <p class="text-sm font-regular {% if not object.is_test %}text-gray-100{% else %}text-gray-600{% endif %} w-6/12">{{ object.description }}</p>
              </div>
              <div class="flex mt-6">

              <!-- Opportunity resources: payment unit, learn app deliver app and its display modal-->
                <div class="flex gap-4" x-data="{
                      showModal: false,
                      selectedTab: '',
                      selectedOption: '',
                      historyLoaded: false,
                  }"
                     x-init="$watch('showModal', value => {
                            document.body.classList.toggle('overflow-hidden', value);
                             if (value && !historyLoaded) {
                               $dispatch('tabShown');
                               historyLoaded = true;
                              }
                        })">
                      <!-- apps list -->
                      {% for app in resources %}
                      <div class="min-w-48 flex flex-row items-center justify-between px-4 h-10 bg-brand-indigo rounded cursor-pointer"
                           @click="showModal = !showModal; ; selectedTab = '{{app.name}}'; selectedOption = '{{app.name}}'">
                          <div class="flex items-center">
                              <i class="fa-light {{app.icon}} text-white text-sm"></i>
                              <h3 class="text-sm font-normal text-white flex-1 pl-2 whitespace-nowrap">{{app.name}}</h3>
                          </div>
                          <h3 class="text-sm font-medium text-white">{{app.count}}</h3>
                      </div>
                      {% endfor %}

                      <!-- Modal -->
                      {% include "tailwind/pages/opportunity_dashboard/opportunity_resource_modal.html" with opp_id=object.id %}
                  </div>
              </div>
          </div>
          <!-- opportunity info -->
          <div class="p-4 rounded-lg {% if not object.is_test %}bg-black/20{% else %}bg-slate-100{% endif %} w-full">
              <div class="flex gap-2 w-full items-center justify-between">
                  {% for data in basic_details %}
                  <div class="flex gap-2 items-start">
                      <div class="{% if not object.is_test %}infocard-light{% else %}infocard-dark{% endif %}">
                          <i class="fa-light {{data.icon}} {% if object.is_test %}!text-brand-cornflower-blue{% endif %} {% if forloop.counter == 3 %} !text-brand-mango {% endif %}"></i>
                          <div>
                              <h6 {% if object.is_test %}class="!text-brand-cornflower-blue"{% endif %}>{{data.name}}</h6>
                              <p>{{data.count}}</p>
                          </div>
                      </div>
                  </div>

                  <!--Separator Between basic detail columns-->
                  {% if not forloop.last and forloop.counter != 2 %}
                      <div class="w-0.5 h-10 {% if not object.is_test %}bg-white{% else %}bg-slate-200{% endif %} bg-opacity-30"></div>
                  {% endif %}
                  {% endfor %}
                  <div>
                    {% if object.is_active %}
                        <span class="badge badge-md positive-dark">Active</span>
                    {% elif object.has_ended %}
                        <span class="badge badge-md warning-dark">Ended</span>
                    {% else %}
                        <span class="badge badge-md negative-dark">Inactive</span>
                    {% endif %}
                  </div>
              </div>
          </div>
      </div>
         <div>
            <!-- Deliveries stats skeleton -->
            <div
              id="opp-stats-container"
              hx-get="{% url 'opportunity:delivery_stats' request.org.slug object.id %}"
              hx-trigger="load"
              hx-target="#opp-stats-container"
              hx-swap="innerHTML"
            >
                <!-- The skeleton loader will be here initially, then replaced by real content -->
                <div id="opp-stats-skeleton">
                  <div class="flex flex-row flex-wrap gap-4 p-4 rounded-t-lg bg-white animate-pulse">
                    {% for _ in "123" %}
                    <div class="w-fit flex-1 flex flex-col gap-4">
                      <div class="flex flex-row items-center gap-2">
                        <div class="flex-1 h-4 bg-gray-200 rounded"></div>
                        <div class="h-3 w-20 bg-gray-200 rounded"></div>
                      </div>
                      {% for _ in "12" %}
                      <div class="flex gap-2 rounded-lg p-4 items-center bg-brand-indigo">
                        <div class="w-10 h-10 rounded-md bg-gray-300 flex items-center justify-center">
                          <div class="w-4 h-4 bg-gray-200 rounded"></div>
                        </div>
                        <div class="flex-1 space-y-1">
                          <div class="h-3 w-20 bg-gray-200 rounded"></div>
                          <div class="h-4 w-24 bg-gray-300 rounded"></div>
                        </div>
                        <div class="h-6 w-10 bg-gray-200 rounded"></div>
                        <div class="ml-2 h-5 w-10 bg-green-300 rounded-full"></div>
                        <div class="h-4 w-4 bg-gray-200 rounded"></div>
                      </div>
                      {% endfor %}
                    </div>
                    {% endfor %}
                  </div>
                </div>
            </div>


             <div
              id="worker-progress-container"
              hx-get="{% url 'opportunity:worker_progress_stats' request.org.slug object.id %}"
              hx-trigger="load"
              hx-target="#worker-progress-container"
              hx-swap="innerHTML"
            >

             <div class="flex gap-4 w-full justify-between p-4 rounded-b-xl bg-white animate-pulse">
              {% for _ in "123" %}
              <div class="flex flex-col p-2 bg-indigo-50 rounded-xl w-full">
                <!-- Section title skeleton -->
                <div class="h-4 w-1/3 bg-indigo-200 rounded my-2"></div>

                <div class="bg-white p-4 rounded-lg">
                  {% for _ in "123" %}
                  <div class="flex gap-8 w-full items-end rounded-lg my-3">
                    <div class="flex flex-col gap-1.5 w-full">
                      <div class="flex gap-4 items-center">
                        <!-- Progress title skeleton -->
                        <div class="h-3 w-1/4 bg-gray-300 rounded"></div>
                        <!-- Badge skeleton -->
                        <div class="h-5 w-10 bg-indigo-100 rounded-full"></div>
                      </div>
                      <!-- Progress bar skeleton -->
                      <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-indigo-300 h-2.5 rounded-full" style="width: 50%"></div>
                      </div>
                    </div>
                    <!-- Total skeleton -->
                    <div class="h-5 w-6 bg-gray-300 rounded"></div>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            </div>
           </div>
        </div>

        <!-- worker progress funnel view -->
        <div id="opp-funnel-container"
              hx-get="{% url 'opportunity:funnel_progress_stats' request.org.slug object.id %}"
              hx-trigger="load"
              hx-target="#opp-funnel-container"
              hx-swap="innerHTML"
            >
            <div class="flex flex-col gap-8 w-full p-8 shadow-sm rounded-xl bg-white animate-pulse">
            <h4 class="text-brand-deep-purple font-medium">Worker Progress Funnel</h4>
            <div class="flex flex-col md:flex-row gap-4 justify-between">
                {% for _ in "1234567" %}
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-2">
                        <div class="bg-indigo-100 h-12 w-12 rounded flex items-center justify-center">
                            <div class="bg-indigo-300 h-6 w-6 rounded"></div>
                        </div>
                        {% if not forloop.last %}
                        <div class="relative w-32 h-0.5 bg-transparent border-dashed border-t-2 border-gray-300 my-6">
                            <div class="absolute -right-1 -top-[6.5px] w-2.5 h-2.5 border-t-2 border-r-2 border-gray-300 rotate-45"></div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="h-6 w-12 bg-gray-200 rounded mx-auto"></div>
                    <div class="h-3 w-20 bg-gray-200 rounded mx-auto"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        </div>

    </div>
{% endblock %}
