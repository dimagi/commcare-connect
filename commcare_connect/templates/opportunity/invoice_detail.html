{% extends "base.html" %}
{% load i18n crispy_forms_tags %}

{% block content %}
{% include 'components/breadcrumbs.html' with path=path %}
<div class="card_bg">
  <div class="card_title mb-4">
    {% if is_service_delivery %}
      {% translate "Review Service Delivery Invoice" %}
    {% else %}
      {% translate "Review Custom Invoice" %}
    {% endif %}
    <span class="badge badge-sm bg-gray-200 text-gray-700 ml-2">{% translate "Read Only" %}</span>
    {% if form.instance.payment %}
      <span class="badge badge-sm bg-gray-200 text-gray-700 ml-2">{% translate "Paid" %}</span>
    {% endif %}
  </div>
  <div x-data="invoiceFormHandler()">
    {% crispy form %}
    <div class="mt-6 flex justify-start gap-4">
      <a href="{% url 'opportunity:invoice_list' org_slug=request.org.slug opp_id=opportunity.opportunity_id %}"
         class="button button-md outline-style">
        {% translate "Back to Invoices" %}
      </a>
      {% if request.is_opportunity_pm %}
        {% if invoice_status == 'submitted' %}
          <button hx-post="{% url 'opportunity:invoice_approve' org_slug=request.org.slug opp_id=opportunity.opportunity_id %}"
                  hx-vals='{"pk": "{{ form.instance.payment_invoice_id }}"}'
                  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                  class="button button-md primary-dark justify-center !inline-flex"
                  {% if form.instance.payment %}disabled{% endif %}>
            {% translate "Pay" %}
          </button>
        {% endif %}
      {% elif invoice_status == 'pending' %}
        <a
          @click="submitForApproval()"
          class="button button-md primary-dark"
        >
          {% translate "Submit for Approval" %}
        </a>
      {% endif %}
    </div>
  </div>
</div>
{% if payment_invoice_invoice_ticket_link_form %}
<br/>
<div class="card_bg">
  <div class="card_title mb-4">
    <div>
      <form
        method="POST"
        action="{% url 'opportunity:update_invoice_invoice_ticket_link' org_slug=request.org.slug opp_id=opportunity.opportunity_id invoice_id=object.payment_invoice_id %}"
      >
        {% csrf_token %}
        <!--
        using the form tag to enforce url field validation provided by the browser itself which seems to not fire when
        the form is passed as an argument to crispy method.
        Though used crispy filter to get the nice rendering provided by crispy.
        -->
        {{ payment_invoice_invoice_ticket_link_form|crispy }}
        <button class="button button-md primary-dark">
          {% translate "Update" %}
        </button>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% include "opportunity/partials/invoice_form_handler.html" with is_read_only=True %}
{% endblock content %}
